---
layout: post
title: Custom STS for Sitefinity 5.x
date: 2013-02-06 21:38:13.000000000 +05:00
type: post
published: true
status: publish
categories:
- Federation/STS
- Sitefinity
- SSO
tags: []
meta:
  _wpas_done_1982054: '1'
  _publicize_done_external: a:1:{s:8:"linkedin";a:1:{s:10:"9w6qkgZkkl";b:1;}}
  _oembed_176282abfc6eb26bec4dc803c7c261da: '{{unknown}}'
  _oembed_0dc0032177bcc0e93a08c4739da6ef5d: '{{unknown}}'
  _oembed_d85e8a2a2675599ccaaa5f3403be0467: '{{unknown}}'
  _oembed_3fe5639b14c0dd5f85621ae78d31ed1f: '{{unknown}}'
  _oembed_754b109a71f1cb80da7306c7b09d2041: '{{unknown}}'
  _oembed_55f91b721b3db0f6d76d167cd066a40c: '{{unknown}}'
  _oembed_d3a20f2de8f614e67af45bf90bb59a2f: '{{unknown}}'
  _oembed_834c7c0b9de6adbe532fd06e63ca4651: '{{unknown}}'
  _oembed_e4901fe5bfed5a1730cfcdac4a996128: '{{unknown}}'
  _oembed_efd7f36283c13a93cc32ada5698687ee: '{{unknown}}'
  _oembed_c63d898c9e90c6cd95cbf91b8c23f042: '{{unknown}}'
  _oembed_7e39098a43a296e8e711f47b457df8a8: '{{unknown}}'
  _oembed_e16c6bdbd6ed158eb43cd892022b9ec7: '{{unknown}}'
  _oembed_d48044f9bdf672da8d9209412e102bd4: '{{unknown}}'
  _oembed_999f7815a4ddcf6e7d0d4f76cf12b697: '{{unknown}}'
  _oembed_b900b08859722e1456057cbfb1164a93: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<p>Sitefinity 5.x introduced claims based security &amp; Single-Sign-On features based on a simple HTTP redirect based token issuance protocol which I’m going to call ‘<strong>Sitefinity sign-in protocol’ </strong>in my posts. Version 5.x has also standardized on using Simple Web Token (SWT) as the default token format for user authentication and SSO needs. </p>
<p>Sitefinity 5.x comes with a built-in local STS which authenticates users using the standard membership authentication and issue SWT tokens in accordance with Sitefinity sign-in protocol. Sitefinity doesn’t have a hard dependency on this built-in STS rather it relies on it’s sign-in protocol and SWT token format which means we can introduce a custom STS in the mix and Sitefinity would happily work with our Custom STS which obviously has to adhere to Sitfinity sign-in protocol and token format. </p>
<p>This STS based design in Sitefinity 5.x could enable many SSO scenarios, some of which I’m going to explore in future posts. Following are examples of few possibilities: </p>
<ul>
<li>I can create a Custom STS and then have multiple applications (RPs :)) including Sitefinity 5.x trust this single STS, which would enable the users to single sign-on across all those applications. </li>
<li>I can create a multi-protocol STS which can enable user SSO across workloads/products. For example, SSO between Sitefinity &amp; Office 365 or another portals, speaking the SAML protocol. </li>
</ul>
<p>For now, I’ll show you how to use a custom STS with Sitefinity for user authentication. I have already developed and deployed a Sitefinity compatible STS @ <a href="http://sts.pilesoft.com">http://sts.pilesoft.com</a> while Sitefinity is running @ <a href="http://pilesoft.com">http://pilesoft.com</a>.</p>
<p><strong>Step 1:</strong> Register custom STS with Sitefinity so that it can trust the token issued by custom STS.</p>
<p>Open the .\App_Data\Sitefinity\Configuration\SecurityConfig.config file and locate the &lt;securityTokenIssuers&gt; element and following line to &lt;securityTokenIssuers&gt; element.</p>
<p>&lt;add key=&quot;CD29559E6EDC312272976AC43F7E921C5766D7063DAF6D177F3EEDEB1802FABE&quot; encoding=&quot;Hexadecimal&quot; membershipProvider=&quot;Default&quot; realm=&quot;<a href="http://sts.pilesoft.com&quot;/">http://sts.pilesoft.com&quot;/</a>&gt;</p>
<p>Your config should now look like following:</p>
<div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:d86c18dd-f1b6-4cc9-aef9-977e9bc9bc19" class="wlWriterEditableSmartContent" style="float:none;margin:0;display:inline;padding:0;">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background:#fff;overflow:auto;">
<ol style="background:#ffffff;margin:0;padding:0 0 0 5px;white-space:nowrap;">
<li><span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">securityTokenIssuers</span><span style="background:#ffffff;color:#0000ff;">&gt;</span></li>
<li style="background:#f3f3f3;">  <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">add</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">key</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">CD29559E6EDC312272976AC43F7E921C5766D7063DAF6D177F3EEDEB1802FABE</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">encoding</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Hexadecimal</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">membershipProvider</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Default</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">realm</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">http://sts.pilesoft.com</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">/&gt;</span></li>
<li>      <span style="background:#ffffff;color:#000000;"></span><span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">add</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">key</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">6C4B865442D166796756C8DA1765584F7DD5EC0DE81B1CF29AC5FCE85AE5331D</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">encoding</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Hexadecimal</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">membershipProvider</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Default</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">realm</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">http://localhost</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span></li>
<li style="background:#f3f3f3;">  <span style="background:#ffffff;color:#000000;"></span><span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">securityTokenIssuers</span><span style="background:#ffffff;color:#0000ff;">&gt;</span></li>
<li><span style="background:#ffffff;color:#0000ff;"></span></li>
<li style="background:#f3f3f3;"><span style="background:#ffffff;color:#0000ff;"></span></li>
<li><span style="background:#ffffff;color:#0000ff;"></span></li>
</ol></div>
</p></div>
</p></div>
<p>&#160;</p>
<p>In most cases, you need to configure a custom Membership provider as well, which I’m going to talk in a future post. </p>
<p><strong>Step 2: </strong>Open the main web.config file and locate the &lt;federatedAuthentication&gt; under the &lt;microsoft.identityModel&gt; section. This is WIF configuration and we need to change the &lt;wsFederation&gt; element to point to our custom STS. </p>
<p>Locate the &lt;wsFederation&gt; element &amp; change the <strong>issuer</strong> attribute to point to our Custom STS as shown below:</p>
<div id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:044e9876-c17c-4d08-a669-403a744816ac" class="wlWriterEditableSmartContent" style="float:none;margin:0;display:inline;padding:0;">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#ffffff;max-height:300px;overflow:auto;padding:2px 5px;white-space:nowrap;"><span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">microsoft.identityModel</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />   <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">service</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">claimsAuthenticationManager</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">type</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Telerik.Sitefinity.Security.Claims.SFClaimsAuthenticationManager, Telerik.Sitefinity</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">securityTokenHandlers</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />       <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">add</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">type</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Telerik.Sitefinity.Security.Claims.SWT.SWTSecurityTokenHandler, Telerik.Sitefinity</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">securityTokenHandlers</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">audienceUris</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">mode</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Never</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">&gt;&lt;/</span><span style="background:#ffffff;color:#a31515;">audienceUris</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">federatedAuthentication</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />       <span style="background:#ffffff;color:#0000ff;"></span><br />     <span style="background:#ffffff;color:#000000;">==&gt;  </span><span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">wsFederation</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">passiveRedirectEnabled</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">true</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><br />                        <span style="background:#ffffff;color:#0000ff;"></span><span style="background:#ffffff;color:#ff0000;">issuer</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">http://sts.pilesoft.com/issue/sitefinity</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">realm</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">http://localhost</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">requireHttps</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">false</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span><br />       <span style="background:#ffffff;color:#0000ff;"></span><br />       <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">cookieHandler</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">requireSsl</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">false</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">federatedAuthentication</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">issuerNameRegistry</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">type</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Telerik.Sitefinity.Security.Claims.CustomIssuerNameRegistry, Telerik.Sitefinity</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />       <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">trustedIssuers</span><span style="background:#ffffff;color:#0000ff;">&gt;&lt;/</span><span style="background:#ffffff;color:#a31515;">trustedIssuers</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">issuerNameRegistry</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br />     <span style="background:#ffffff;color:#0000ff;">&lt;</span><span style="background:#ffffff;color:#a31515;">issuerTokenResolver</span><span style="background:#ffffff;color:#0000ff;"> </span><span style="background:#ffffff;color:#ff0000;">type</span><span style="background:#ffffff;color:#0000ff;">=</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;">Telerik.Sitefinity.Security.Claims.SWT.WrapIssuerTokenResolver, Telerik.Sitefinity</span><span style="background:#ffffff;color:#000000;">&quot;</span><span style="background:#ffffff;color:#0000ff;"> /&gt;</span><br />   <span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">service</span><span style="background:#ffffff;color:#0000ff;">&gt;</span><br /> <span style="background:#ffffff;color:#0000ff;">&lt;/</span><span style="background:#ffffff;color:#a31515;">microsoft.identityModel</span><span style="background:#ffffff;color:#0000ff;">&gt;</span></div>
</p></div>
</p></div>
<p>&#160;</p>
<p>Now if I browse to Sitefinity – I get:</p>
<p><a href="http://zuahmed.files.wordpress.com/2013/02/image.png"><img title="image" style="border-top:0;border-right:0;border-bottom:0;border-left:0;display:inline;" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb.png" width="244" height="153" /></a> </p>
<p>When I click on ‘Login to the backend link’, I’m redirected to my Custom STS. The address bar shows the sitefinity sign-in protocol in action. </p>
<p><a href="http://zuahmed.files.wordpress.com/2013/02/image1.png"><img title="image" style="border-top:0;border-right:0;border-bottom:0;border-left:0;display:inline;" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb1.png" width="244" height="153" /></a></p>
<p>When I sign-in at the STS, it issues a SWT token &amp; redirects me back to the Sitefinity app. </p>
<p>As this STS is trusted by Sitefinity, it happily accepts the incoming SWT token and logs me in. </p>
<p><a href="http://zuahmed.files.wordpress.com/2013/02/image2.png"><img title="image" style="border-top:0;border-right:0;border-bottom:0;border-left:0;display:inline;" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb2.png" width="244" height="188" /></a> </p>
<p>I’ll publish the Custom STS code after removing the IP related bits. Ping me if you desperately needs it :)</p>
