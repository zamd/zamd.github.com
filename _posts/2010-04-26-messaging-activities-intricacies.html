---
layout: post
title: Messaging activities intricacies
date: 2010-04-26 16:46:44.000000000 +05:00
type: post
published: true
status: publish
categories:
- WF4
tags:
- Send activity Channel Caching
meta:
  _edit_last: '13661190'
  _oembed_181b91adc83626b3562627a35400c5c0: '{{unknown}}'
  _oembed_a3a22ade484458dc3300ea79f86f7f0f: '{{unknown}}'
  _oembed_f4d044393bf76ec742d2c2d81e11bcee: '{{unknown}}'
  _oembed_ed1d12a3abadcefeecb8f25e43d460c8: '{{unknown}}'
  _oembed_3423f8651f33d6d15f1826b15d4bc799: '{{unknown}}'
  _oembed_e1c8c46b25e41acc40400e55fb3fa3d9: '{{unknown}}'
  _oembed_2c6cc4500e90bd5b5a5d8976f060c166: '{{unknown}}'
  _oembed_0221f0b957f316a2c5fceb1993a77ebf: '{{unknown}}'
  _oembed_26c8ce82084220058bbca2acc13d3725: '{{unknown}}'
  _oembed_caf0e245fbddca46082c693d0be2d294: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<p class="MsoNormal">WF 4 introduced messaging activities which provides a visual way of creating web services and their clients.<span>&#160; </span>In VS 2010 when you do “Add Service Reference” (in a workflow project), the wizard automatically generates activities and config in contrast to <i>imperative </i>code and config (the <i>legacy way </i><i><span style="font-family:wingdings;"><span>J</span></span>). </i>This looks cool as you can simply drag &amp; drop these activities on a workflow surface and use them to consume your web services.<span>&#160; </span>But how does these activities lay themselves on top of WCF ChannelFactory/Channel API?</p>
<p class="MsoNormal">Send activity is a wrapper around WCF ChannelFactory/Channel API and there is a cache layer built into Send activity’s infrastructure as well. By default, this caching layer is only used in a <b><i>safe caching </i></b>mode, where Endpoint information is specified using the properties of Send activity and you are using one of the stock Bindings without any modifications. As soon as you load Binding information from the config (regardless if you have changed the binding or not) safe caching will be disabled.</p>
<p class="MsoNormal">Without caching, default WSHttpBinding is not suitable for workflow scenarios as it will negotiate credentials (which is a 2 legs handshake) &amp; then establish a secure conversation session (another leg). But then this would be only be used for a single message and needs to be done for every message generated by the Send activity. In my simple example, I have following service which is using default wsHttpBinding and I used VS “Add Service Reference” to generate a client.</p>
<p class="MsoNormal"><span><a href="http://zuahmed.files.wordpress.com/2010/04/clip_image002.jpg"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="clip_image002" border="0" alt="clip_image002" src="{{ site.baseurl }}/assets/clip_image002_thumb.jpg" width="168" height="244" /></a></span></p>
<p class="MsoNormal">The wizard has generated following two activities and along with some default config (default wsHttpBinding)</p>
<p class="MsoNormal"><span><a href="http://zuahmed.files.wordpress.com/2010/04/clip_image004.jpg"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="clip_image004" border="0" alt="clip_image004" src="{{ site.baseurl }}/assets/clip_image004_thumb.jpg" width="244" height="63" /></a></span></p>
<p class="MsoNormal">I then used these activities to craft a basic client which looks like this:</p>
<p class="MsoNormal"><span><a href="http://zuahmed.files.wordpress.com/2010/04/clip_image006.jpg"><img style="border-bottom:0;border-left:0;display:inline;border-top:0;border-right:0;" title="clip_image006" border="0" alt="clip_image006" src="{{ site.baseurl }}/assets/clip_image006_thumb.jpg" width="219" height="244" /></a></span></p>
<p class="MsoNormal">With this simple arrangement my message flow looks this: For Operation1 calls, following 4 infrastructure messages are generated. Note these are request-reply message so each of them has reply message too.</p>
<p class="MsoNormal"><a href="http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue"><b><span style="font-family:&quot;font-size:8pt;">http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue</span></b></a><b><span style="font-family:&quot;font-size:8pt;"></p>
<p>     </span></b></p>
<p class="MsoNormal"><a href="http://schemas.xmlsoap.org/ws/2005/02/trust/RSTR/Issue"><b><span style="font-family:&quot;font-size:8pt;">http://schemas.xmlsoap.org/ws/2005/02/trust/RSTR/Issue</span></b></a><b><span style="font-family:&quot;font-size:8pt;"></p>
<p>     </span></b></p>
<p class="MsoNormal"><b><span style="font-family:&quot;font-size:8pt;">
<p>&#160;</p>
<p>     </span></b></p>
<p class="MsoNormal"><a href="http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT"><b><span style="font-family:&quot;font-size:8pt;">http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT</span></b></a><b><span style="font-family:&quot;font-size:8pt;"></p>
<p>     </span></b></p>
<p class="MsoNormal"><b><span style="font-family:&quot;font-size:8pt;">
<p>&#160;</p>
<p>     </span></b></p>
<p class="MsoNormal"><a href="http://tempuri.org/IService/Operation1"><b><span style="font-family:&quot;font-size:8pt;">http://tempuri.org/IService/Operation1</span></b></a><b><span style="font-family:&quot;font-size:8pt;"></p>
<p>     </span></b></p>
<p class="MsoNormal"><a href="http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT/Cancel"><b><span style="font-family:&quot;font-size:8pt;">http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT/Cancel</span></b></a><b><span style="font-family:&quot;font-size:8pt;"></p>
<p>     </span></b></p>
<p class="MsoNormal">
<p class="MsoNormal">By default, wsHttpBinding<span>&#160; </span>is optimized for security and performance – so it establishes a secure conversation which has an upfront cost but applying security for subsequent messages is much cheaper. But unfortunately, in workflow world we only transmit one message as part of secure session, as the second call would use a brand new factory, and all of this will be done again. <span></p>
<p>     </span></p></p>
<p class="MsoNormal">Now you can argue here that your binding is still the same default wsHttpBinding binding, why messaging activities didn’t use channel factory caching in this case.<span>&#160; </span>As binding information is now coming from the configuration file, messaging activities can’t safely determine that you are using the default binding hence caching is disabled.<span>&#160; </span>If you know for sure that you binding is still secure for sharing (as in this case, it was the same default wsHttpBinding) you can enable <span style="font-family:consolas;font-size:9.5pt;">UnsafeCaching </span>which will then reuse the ChannelFactory for sending messages to the same endpoint<span style="font-family:consolas;font-size:9.5pt;">. Caching API is exposed via <span style="color:#2b91af;">SendMessageChannelCache </span></span>class, which can be added as an extension into your Workflow Host.</p>
<p class="MsoNormal"><span style="font-family:consolas;color:blue;font-size:9.5pt;">class</span><span style="font-family:consolas;font-size:9.5pt;"> <span style="color:#2b91af;">Program</span></p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;">{</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160; </span><span style="color:blue;">static</span> <span style="color:blue;">void</span> Main(<span style="color:blue;">string</span>[] args)</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160; </span>{</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:blue;">var</span> invoker = <span style="color:blue;">new</span> <span style="color:#2b91af;">WorkflowInvoker</span>(<span style="color:blue;">new</span> <span style="color:#2b91af;">Workflow1</span>());</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;">
<p>&#160;</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:blue;">var</span> cache = <span style="color:blue;">new</span> <span style="color:#2b91af;">SendMessageChannelCache</span> { AllowUnsafeCaching = <span style="color:blue;">true</span>, };</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>invoker.Extensions.Add(</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span>&#160;&#160; </span><span style="color:blue;">delegate</span></p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>{</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color:blue;">return</span> cache;</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>}</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>);</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>invoker.Invoke();</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160;&#160;&#160;&#160; </span><span>&#160;</span>cache.Dispose();</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;"><span>&#160;&#160;&#160; </span>}</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;font-size:9.5pt;">}</p>
<p>   </span></p>
<p class="MsoNormal"><span style="font-family:consolas;color:#2b91af;font-size:9.5pt;">
<p>&#160;</p>
<p>   </span></p>
<p class="MsoNormal">In above example, cache is added as an Instance level cache (notice I’m using Func&lt;&gt; delegate). Cache can be shared at different scopes; Host &amp; AppDomain are the other two options.<span>&#160; </span>With above modification you would get the expected behaviour:<span></p>
<p>   </span></p>
<p class="MsoNormal">Secure conversation session is established at the start and would be used to secure all subsequent messages to the same endpoint.</p>
<p class="MsoNormal">Remember, you are now getting sessions on the server side and you would have to explicit close those sessions otherwise they will stay hanging and will ultimately saturate your session throttles.</p>
<p class="MsoNormal">You can close the active sessions by disposing the cache. This will send the Cancel message to the sessions.</p>
<p class="MsoNormal"><a name="_GoBack"></a><b><span style="font-family:&quot;font-size:8pt;">
<p>&#160;</p>
<p>     </span></b></p>
<p class="MsoNormal"><a href="http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT/Cancel"><b><span style="font-family:&quot;font-size:8pt;">http://schemas.xmlsoap.org/ws/2005/02/trust/RST/SCT/Cancel</span></b></a></p>
<p class="MsoNormal">Please note, this is just one example of optimizing the messaging when using workflow services activities.</p>
