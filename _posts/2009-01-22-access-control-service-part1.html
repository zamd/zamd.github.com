---
layout: post
title: Access Control Service - Part1
date: 2009-01-22 13:44:15.000000000 +05:00
type: post
published: true
status: publish
categories:
- .NET Services
tags: []
meta:
  _edit_last: '13661190'
  _oembed_49f037572bede8ab79746a3df13d478a: '{{unknown}}'
  _oembed_2c58d793c9dca5999e3fff1819036f58: '{{unknown}}'
  _oembed_1769f2c23d6d3120874b9a72e8db2e0c: '{{unknown}}'
  _oembed_5f11243cdedb7b7faa5a497f8388cce8: '{{unknown}}'
  _oembed_ecf431b6b91c2bd9bac543f7ab405d63: '{{unknown}}'
  _oembed_5abdc9abc2d878c872ea0c98a3b8f3fe: '{{unknown}}'
  _oembed_bebf3d740bb3c6a07e98ba30215462e2: '{{unknown}}'
  _oembed_f3c4fa217f397d2112407c597912cdc3: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal">.Net Services include a service known as “<a href="http://portal.ex.azure.microsoft.com/">Access Control Service</a>”, which is a cloud based Security Token Service (STS). </p>
<p class="MsoNormal">ACS supports both active (WS-Trust) and passive (WS-Federation) clients.  In this post I will talk about WS-Trust support in ACS. </p>
<p class="MsoNormal">Basic function of any STS is to accepts a token and return a different token essentially doing claims transformation. This claims transformation is also at the core of ACS. It use a very flexible rule based transformation engine to map input claims into output claims.  I have already signed up for .NET Services account and also downloaded &amp; installed the SDK which includes some useful end-2-end samples. I will start with individual pieces and then try to connect them together in step by step manner. </p>
<p class="MsoNormal">Ok let’s see how we can talk to ACS just like another web service? ACS token issuance functionality is available using many different bindings (you can easily get this list by using “Add Service Reference” command or svcutil.exe). </p>
<p class="MsoNormal">Now thinking in terms of WCF: we already got a service, which is accessible over internet, so we need a WCF proxy to call it. </p>
<p class="MsoNormal"><a href="http://www.zamd.net/2008/07/10/CreatingABasicSTSUsingGenevaFrameworkAkaZermatt.aspx">Geneva Framework</a> introduced a new class known as WSTrustClient – As the name suggest, this class is a WCF proxy for WS-Trust contract. If you can’t use Geneva Framework then this same functionality is also provided by WCF. Please see my other post on <a href="http://www.zamd.net/2008/07/11/SAMLTokenRequestor.aspx">IssuedSecurityTokenProvider</a>.  In this post – I’m going to use Geneva Framework because that’s the recommended approach for this scenario. Here is the code we can use to invoke ACS. </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">private</span><span style="font-size:10pt;font-family:'Courier New';"> <span style="color:blue;">static</span> <span style="color:blue;">void</span> AcquireTokenFromACSUsingUserName()</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">{</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> binding = <span style="color:blue;">new</span> <span style="color:#2b91af;">WS2007HttpBinding</span>(<span style="color:#a31515;">"userNameForCert"</span>);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:green;">//ACS(STS) signing certificate...       </span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:green;">//Replace following string with actual ACS cert string</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> certData = <span style="color:#2b91af;">Convert</span>.FromBase64String(<span style="color:#a31515;">"AwAAAAEOoik="</span>);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> acsCert = <span style="color:blue;">new</span> <span style="color:#2b91af;">X509Certificate2</span>(certData);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> identity = <span style="color:blue;">new</span> <span style="color:#2b91af;">X509CertificateEndpointIdentity</span>(acsCert);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> epa = <span style="color:blue;">new</span> <span style="color:#2b91af;">EndpointAddress</span>(<span style="color:blue;">new</span> <span style="color:#2b91af;">Uri</span>(<span style="color:#a31515;">"http://accesscontrol.windows.net/sts/eval01/username for certificate"</span>), identity);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> trustVersion = <span style="color:#2b91af;">TrustVersion</span>.WSTrust13;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> clientCredentials = <span style="color:blue;">new</span> <span style="color:#2b91af;">ClientCredentials</span>();</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    clientCredentials.UserName.UserName = <span style="color:#a31515;">"your solution userName"</span>;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    clientCredentials.UserName.Password = <span style="color:#a31515;">"your solution password"</span>;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:#2b91af;">WSTrustClient</span> client = <span style="color:blue;">new</span> <span style="color:#2b91af;">WSTrustClient</span>(binding, epa, trustVersion, clientCredentials);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:#2b91af;">RequestSecurityToken</span> rst = <span style="color:blue;">new</span> <span style="color:#2b91af;">RequestSecurityToken</span>(<span style="color:#2b91af;">RequestTypeConstants</span>.Issue, <span style="color:#2b91af;">KeyTypeConstants</span>.Symmetric);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    rst.AppliesTo = <span style="color:blue;">new</span> <span style="color:#2b91af;">EndpointAddress</span>(<span style="color:#a31515;">"http://zamd.net"</span>);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:#2b91af;">RequestSecurityTokenResponse</span> rstr;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:green;">// Send token issuance request to ACS.</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="color:blue;">var</span> samltok = client.Issue(rst, <span style="color:blue;">out</span> rstr);</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">}</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">By running above – I get a token back from ACS. </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"><img src="{{ site.baseurl }}/assets/image00112.png" border="0" alt="" width="1158" height="156" /></span><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">Now Because I own the certificate for relying part (zamd.net) – I have written some code to decrypt the issued token to see the returned claims. Here is that code: </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">    <span style="background:yellow;color:blue;">var</span><span style="background:yellow;"> rpCert = <span style="color:blue;">new</span> <span style="color:#2b91af;">X509Certificate2</span>(<span style="color:#a31515;">"zamdnetprivatekeycert.pfx"</span>, <span style="color:#a31515;">"a"</span>);</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;background:yellow;font-family:'Courier New';">    <span style="color:blue;">var</span> token = samltoken <span style="color:blue;">as</span> <span style="color:#2b91af;">GenericXmlSecurityToken</span>;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;background:yellow;font-family:'Courier New';">    <span style="color:blue;">var</span> txtStat = ExtractSAMLAssertion(token, rpCert);</span><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">Following SAML assertion is returned in the response token.</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeStatement</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:saml</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">urn:oasis:names:tc:SAML:1.0:assertion</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Subject</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:SubjectConfirmation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:ConfirmationMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">urn:oasis:names:tc:SAML:1.0:cm:holder-of-key<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:ConfirmationMethod</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2000/09/xmldsig#</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">        &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptedKey</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:e</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2001/04/xmlenc#</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptionMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">Algorithm</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">            &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">DigestMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">Algorithm</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2000/09/xmldsig#sha1</span>"<span style="color:blue;"> /&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptionMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">            &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">o:SecurityTokenReference</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:o</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">              &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509Data</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">                &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerSerial</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">                  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">CN=Root Agency<span style="color:blue;">&lt;/</span><span style="color:#a31515;">X509IssuerName</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">                  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509SerialNumber</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">53391460269745460375752793295988585963<span style="color:blue;">&lt;/</span><span style="color:#a31515;">X509SerialNumber</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">                &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerSerial</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">              &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509Data</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">            &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">o:SecurityTokenReference</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherData</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">            &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">m7738wsrTe1GVNHl3wl1QEq4AJBERZY7GI7MMlWqRZBjM8T2UbrtK7M40+2JEm0JpgDMnVoq8Zhc8V5ui20lHKhAw2fOYSUBU529ZBzqKbYqDvIGApTXlp9ZVTvqS+Xo2kM315XtURkPHqmWvMA2eUUdZjA9tC+pvulWcuG2N4E=<span style="color:blue;">&lt;/</span><span style="color:#a31515;">e:CipherValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherData</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">        &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptedKey</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:SubjectConfirmation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Subject</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">username</span>"<span style="color:blue;"> </span><span style="color:red;">AttributeNamespace</span><span style="color:blue;">=</span>"<span style="color:blue;">http://schemas.microsoft.com/strata/2008/09/accesscontrol/claims</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">Eval01<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:AttributeValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">action</span>"<span style="color:blue;"> </span><span style="color:red;">AttributeNamespace</span><span style="color:blue;">=</span>"<span style="color:blue;">http://docs.oasis-open.org/wsfed/authorization/200706/claims</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">Eval01Confirmed<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:AttributeValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">name</span>"<span style="color:blue;"> </span><span style="color:red;">AttributeNamespace</span><span style="color:blue;">=</span>"<span style="color:blue;">http://schemas.xmlsoap.org/ws/2005/05/identity/claims</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">Zulfiqar Ahmed (Orignal)<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:AttributeValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">upn</span>"<span style="color:blue;"> </span><span style="color:red;">AttributeNamespace</span><span style="color:blue;">=</span>"<span style="color:blue;">http://schemas.xmlsoap.org/ws/2005/05/identity/claims</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">Eval01<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:AttributeValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">name</span>"<span style="color:blue;"> </span><span style="color:red;">AttributeNamespace</span><span style="color:blue;">=</span>"<span style="color:blue;">http://schemas.xmlsoap.org/ws/2005/05/identity/claims</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">Eval01<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:AttributeValue</span><span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeStatement</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">So how does ACS decided to include these and only these claims in the returned token? Becase I have configured it using the portal- my portal configuration looks like following:</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"><img src="{{ site.baseurl }}/assets/image0021.png" border="0" alt="" width="694" height="350" /></span><span style="font-size:10pt;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span> </p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">Finally here is WCF binding used to talk to ACS.<span style="color:blue;"> </span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">bindings</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">ws2007HttpBinding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">        &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">name</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">userNameForCert</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">mode</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Message</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">            &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">message</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">clientCredentialType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">UserName</span>"<span style="color:blue;"> </span><span style="color:red;">negotiateServiceCredential</span><span style="color:blue;">=</span>"<span style="color:blue;">false</span>"</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">              </span><span style="font-size:10pt;color:red;font-family:'Courier New';">establishSecurityContext</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"<span style="color:blue;"> /&gt;</span></span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">        &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">ws2007HttpBinding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">bindings</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
</div>
