---
layout: post
title: Pub/Sub with WCF (Part 2)
date: 2011-05-25 22:18:13.000000000 +05:00
type: post
published: true
status: publish
categories:
- ServiceBusV2
tags: []
meta:
  _edit_last: '13661190'
  _oembed_78b36375d7ff020c4b5ec62af28c54a0: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<p><strong><a href="http://cid-724b6fcd63a8c1ac.office.live.com/self.aspx/zamd.net/ServiceBusPromotedPropertiesExtensions.zip">Source Code Download</a></strong></p>
<p>Service Bus May CTP has a small glitch when it comes to pub/sub messaging using the WCF programing model. The May CTP API out-of-box doesn’t pick up filter/promoted properties from the WCF data contracts and requires you to explicitly specify these properties on the BrokeredMessage object outside of core WCF programing model as shown in <a href="http://zamd.net/2011/05/19/pubsub-with-wcf-part-1/">part 1</a>.</p>
<p>I didn’t like this repetition and decided to prototype a solution using the WCF extensibility model and after few hours of coding created a solution which looks quite cool :)</p>
<p>In my solution a DataMember can be marked with [PromotedProperty] attribute and a custom operation behavior picks these annotations and promote them as filter properties by automatically attaching them with the outgoing message.</p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    </span><span style="color:#0000ff;">public</span><span style="color:#000000;"> </span><span style="color:#0000ff;">class</span><span style="color:#000000;"> </span><span style="color:#2b91af;">Order</span><br />
</span><span style="font-family:Consolas;"><span style="color:#000000;">    {<br />
</span><span style="color:#0000ff;">public</span><span style="color:#000000;"> </span><span style="color:#0000ff;">double</span><span style="color:#000000;"> Amount { </span><span style="color:#0000ff;">get</span><span style="color:#000000;">; </span><span style="color:#0000ff;">set</span></span><span style="font-family:Consolas;"><span style="color:#000000;">; }<br />
</span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#000000;">[</span><span style="color:#2b91af;">PromotedProperty</span><span style="color:#000000;">]</span></span><br />
<span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#000000;"> </span><span style="color:#0000ff;">string</span><span style="color:#000000;"> ShipCity { </span><span style="color:#0000ff;">get</span><span style="color:#000000;">; </span><span style="color:#0000ff;">set</span></span><span style="font-family:Consolas;"><span style="color:#000000;">; }<br />
}</p>
<p>[</span><span style="color:#2b91af;">ServiceContract</span></span><span style="font-family:Consolas;"><span style="color:#000000;">]<br />
</span><span style="color:#0000ff;">public</span><span style="color:#000000;"> </span><span style="color:#0000ff;">interface</span><span style="color:#000000;"> </span><span style="color:#2b91af;">IOrderService</span><br />
</span><span style="font-family:Consolas;"><span style="color:#000000;">    {<br />
[</span><span style="color:#2b91af;">OperationContract</span><span style="color:#000000;">(Name = </span><span style="color:#a31515;">"SubmitFlat"</span><span style="color:#000000;">, IsOneWay = </span><span style="color:#0000ff;">true</span></span><span style="font-family:Consolas;"><span style="color:#000000;">)]<br />
</span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#000000;">[</span><span style="color:#2b91af;">PropertyPromotionBehavior</span><span style="color:#000000;">]</span></span><br />
<span style="color:#000000;">        </span><span style="color:#0000ff;">void</span><span style="color:#000000;"> Submit(</span><span style="color:#0000ff;">double</span><span style="color:#000000;"> amount, [</span><span style="color:#2b91af;">PromotedProperty</span><span style="color:#000000;">] </span><span style="color:#0000ff;">string</span></span><span style="font-family:Consolas;"><span style="color:#000000;"> shipCity);</p>
<p>[</span><span style="color:#2b91af;">OperationContract</span><span style="color:#000000;">(IsOneWay = </span><span style="color:#0000ff;">true</span></span><span style="font-family:Consolas;"><span style="color:#000000;">)]<br />
[</span><span style="color:#2b91af;">PropertyPromotionBehavior</span></span><span style="font-family:Consolas;"><span style="color:#000000;">]<br />
</span><span style="color:#0000ff;">void</span><span style="color:#000000;"> Submit(</span><span style="color:#2b91af;">Order</span><span style="color:#000000;"> order);<br />
}</span></span></p>
<p>I have decided to use a custom formatter to implement property lifting and injection functionality primarily because at the formatter level I still have a fairly typed view of the method call. At message inspector level most of typed-ness has gone and it would have required more work.</p>
<p>The [PropertyPromotionBehavior] creates a ‘promotion model’ (list of properties needs to be promoted) by reflecting on the data contract. The ‘promotion model’ is then populated by the custom formatter with actual parameter values extracted from the call context. [PropertyPromotionBehavior] also replaces the default formatter with a custom <strong>PromotionFormatter </strong>which wraps the default formatter and does the additional work of property promotion. I have highlighted the relevant bits below.</p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    [</span><span style="color:#2b91af;">AttributeUsage</span><span style="color:#000000;">(</span><span style="color:#2b91af;">AttributeTargets</span><span style="color:#000000;">.Method)]</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">class</span><span style="color:#2b91af;">PropertyPromotionBehaviorAttribute</span><span style="color:#000000;"> : </span><span style="color:#2b91af;">Attribute</span><span style="color:#000000;">, </span><span style="color:#2b91af;">IOperationBehavior</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">void</span><span style="color:#000000;"> Validate(</span><span style="color:#2b91af;">OperationDescription</span><span style="color:#000000;"> operationDescription) { }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">void</span><span style="color:#000000;"> ApplyDispatchBehavior(</span><span style="color:#2b91af;">OperationDescription</span><span style="color:#000000;"> operationDescription, </span><span style="color:#2b91af;">DispatchOperation</span><span style="color:#000000;"> dispatchOperation) { }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">void</span><span style="color:#000000;"> ApplyClientBehavior(</span><span style="color:#2b91af;">OperationDescription</span><span style="color:#000000;"> operationDescription, </span><span style="color:#2b91af;">ClientOperation</span><span style="color:#000000;"> clientOperation)</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">var</span><span style="color:#000000;"> promotedProperties = </span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#000000;">LoadPromotedProperties(operationDescription);</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">if</span><span style="color:#000000;"> (promotedProperties.Count &lt;= 0) </span><span style="color:#0000ff;">return</span><span style="color:#000000;">;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">var</span><span style="color:#000000;"> dummy = </span><span style="color:#0000ff;">new</span><span style="color:#2b91af;">ClientOperation</span><span style="color:#000000;">(clientOperation.Parent, </span><span style="color:#a31515;">"dummy"</span><span style="color:#000000;">, </span><span style="color:#a31515;">"urn:dummy"</span><span style="color:#000000;">);</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">var</span><span style="color:#000000;"> behavior =</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">                operationDescription.Behaviors.Find&lt;</span><span style="color:#2b91af;">DataContractSerializerOperationBehavior</span><span style="color:#000000;">&gt;() </span><span style="color:#0000ff;">as</span><span style="color:#2b91af;">IOperationBehavior</span><span style="color:#000000;">;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            behavior.ApplyClientBehavior(operationDescription, dummy);</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#000000;">clientOperation.Formatter = </span><span style="color:#0000ff;">new</span><span style="color:#2b91af;">PromotionFormatter</span><span style="color:#000000;">(dummy.Formatter, promotedProperties);</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">            clientOperation.SerializeRequest = dummy.SerializeRequest;</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">void</span><span style="color:#000000;"> AddBindingParameters(</span><span style="color:#2b91af;">OperationDescription</span><span style="color:#000000;"> operationDescription, </span><span style="color:#2b91af;">BindingParameterCollection</span><span style="color:#000000;"> bindingParameters) { }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">       ...</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    </span><span style="color:#0000ff;">class</span><span style="color:#2b91af;">PromotionFormatter</span><span style="color:#000000;"> : </span><span style="color:#2b91af;">IClientMessageFormatter</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">private</span><span style="color:#0000ff;">readonly</span><span style="color:#2b91af;">IClientMessageFormatter</span><span style="color:#000000;"> _orignalFormatter;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">private</span><span style="color:#0000ff;">readonly</span><span style="color:#2b91af;">IList</span><span style="color:#000000;">&lt;</span><span style="color:#2b91af;">PromotedPropertyDescription</span><span style="color:#000000;">&gt; _promotions;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#000000;"> PromotionFormatter(</span><span style="color:#2b91af;">IClientMessageFormatter</span><span style="color:#000000;"> orignalFormatter, </span><span style="color:#2b91af;">IList</span><span style="color:#000000;">&lt;</span><span style="color:#2b91af;">PromotedPropertyDescription</span><span style="color:#000000;">&gt; promotions)</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            _orignalFormatter = orignalFormatter;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            _promotions = promotions;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">object</span><span style="color:#000000;"> DeserializeReply(</span><span style="color:#2b91af;">Message</span><span style="color:#000000;"> message, </span><span style="color:#0000ff;">object</span><span style="color:#000000;">[] parameters)</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">return</span><span style="color:#000000;"> _orignalFormatter.DeserializeReply(message, parameters);</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        </span><span style="color:#0000ff;">public</span><span style="color:#2b91af;">Message</span><span style="color:#000000;"> SerializeRequest(</span><span style="color:#2b91af;">MessageVersion</span><span style="color:#000000;"> messageVersion, </span><span style="color:#0000ff;">object</span><span style="color:#000000;">[] parameters)</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        {</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">var</span><span style="color:#000000;"> message = _orignalFormatter.SerializeRequest(messageVersion, parameters);</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;text-indent:36pt;margin:0 0 0 36pt;"><span style="font-family:Consolas;"><span style="color:#000000;">...</span></span></p>
<p class="MsoNormal" style="line-height:normal;text-indent:36pt;margin:0 0 0 36pt;"><span style="font-family:Consolas;"><span style="color:#000000;">...</span></span></p>
<p class="MsoNormal" style="line-height:normal;text-indent:36pt;margin:0 0 0 36pt;"><span style="font-family:Consolas;"><span style="color:#000000;"> </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#0000ff;">if</span></span><span style="background:none transparent scroll repeat 0 0;"><span style="color:#000000;"> (_promotions.Count &gt; 0)</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">            {</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                </span><span style="color:#0000ff;">var</span><span style="color:#000000;"> bmp = </span><span style="color:#0000ff;">new</span><span style="color:#2b91af;">BrokeredMessageProperty</span><span style="color:#000000;">();</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                </span><span style="color:#0000ff;">foreach</span><span style="color:#000000;"> (</span><span style="color:#0000ff;">var</span><span style="color:#000000;"> promotion </span><span style="color:#0000ff;">in</span><span style="color:#000000;"> _promotions)</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                {</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                    bmp.Properties[promotion.Name] = promotion.Value;</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                }</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">                message.Properties[</span><span style="color:#2b91af;">BrokeredMessageProperty</span><span style="color:#000000;">.Name] = bmp;</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="background:none transparent scroll repeat 0 0;"><span style="font-family:Consolas;"><span style="color:#000000;">            }</span></span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">                                                               </span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">            </span><span style="color:#0000ff;">return</span><span style="color:#000000;"> message;</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">        }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;"><span style="font-family:Consolas;"><span style="color:#000000;">    }</span></span></p>
<p class="MsoNormal" style="line-height:normal;margin:0;">
<p class="MsoNormal" style="line-height:normal;margin:0;">With these extensions in place, the code looks just like the normal WCF code and property promotion happens in the background as you would expect.</p>
<p class="MsoNormal" style="line-height:normal;margin:0;">
<pre style="margin:0;"><span style="color:#0000ff;font-family:Consolas;">var</span><span style="font-family:Consolas;"><span style="color:#000000;"> cf = </span><span style="color:#0000ff;">new</span><span style="color:#000000;"> </span><span style="color:#2b91af;">ChannelFactory</span><span style="color:#000000;">&lt;</span><span style="color:#2b91af;">IOrderService</span></span><span style="font-family:Consolas;"><span style="color:#000000;">&gt;(serviceBusBinding, topicAddress); </span></span></pre>
<pre style="margin:0;"><span style="font-family:Consolas;"><span style="color:#0000ff;">var</span><span style="color:#000000;"> proxy = cf.CreateChannel();</span></span></pre>
<pre style="margin:0;"></pre>
<p><span style="font-family:Consolas;"><span style="color:#000000;">proxy.Submit(</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> </span><span style="color:#2b91af;">Order</span><span style="color:#000000;"> { Amount = 200, ShipCity = </span><span style="color:#a31515;">"london"</span></span><span style="font-family:Consolas;"><span style="color:#000000;"> });</p>
<p>proxy.Submit(</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> </span><span style="color:#2b91af;">Order</span><span style="color:#000000;"> { Amount = 322, ShipCity = </span><span style="color:#a31515;">"reading"</span></span><span style="font-family:Consolas;"><span style="color:#000000;"> });</p>
<p>proxy.Submit(101, </span><span style="color:#a31515;">"reading"</span></span><span style="font-family:Consolas;"><span style="color:#000000;">);</p>
<p></span><span style="color:#2b91af;">Console</span><span style="color:#000000;">.WriteLine(</span><span style="color:#a31515;">"Submitted."</span><span style="color:#000000;">);</span></span></p>
<p>Hopefully Service Bus programing model will support this kind of behavior soon but for the time being these extensions would probably fill the gap.</p>
<p>I have attached complete source code with this post so please feel free to download and use.</p>
