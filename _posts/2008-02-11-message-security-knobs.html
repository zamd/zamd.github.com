---
layout: post
title: Message security knobs
date: 2008-02-11 11:46:31.000000000 +05:00
type: post
published: true
status: publish
categories:
- WCF
tags: []
meta:
  _edit_last: '13661190'
  _oembed_92cbf1415fb51f9d1e2f5f495eb0c432: '{{unknown}}'
  _oembed_847f8b7b3ff4ccad91017b9c69527b9b: '{{unknown}}'
  _oembed_470d3b38038ea8deec9a74295c6f0b59: '{{unknown}}'
  _oembed_d6f1eaea93ac6b05902e6526fdd16f1a: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal">Security in WCF is all about credentials. Credentials are used for authentication; claims extracted from the credentials are used for authorization. If credential contains keys then these are used to provide integrity and confidentiality. </p>
<p class="MsoNormal">Credentials are supported both at transport level and message level. For message level credentials, WS-Security specification defines the mechanism to encapsulate security token (serialized representation of credentials) in a SOAP message. </p>
<p class="MsoNormal">When you use message security with WCF there are couple of interesting knobs which I am going to explain in this post. So let’s consider the following snippet as an example. </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">message</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">clientCredentialType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">UserName</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">         </span><span style="font-size:10pt;color:red;font-family:'Courier New';">establishSecurityContext</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">         </span><span style="font-size:10pt;color:red;font-family:'Courier New';">negotiateServiceCredential</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">         </span><span style="font-size:10pt;color:red;font-family:'Courier New';">algorithmSuite</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Default</span>"<span style="color:blue;">/&gt;</span></span> </p>
<p class="MsoListParagraph" style="margin-left:.75in;text-indent:-.25in;"><span style="font-family:Symbol;">·<span style="font:7pt 'Times New Roman';">         </span></span><strong><span style="font-size:10pt;font-family:'Courier New';">establishSecurityContext</span></strong> </p>
<p class="MsoNormal">Setting <em><span style="font-size:10pt;color:red;font-family:'Courier New';">establishSecurityContext</span></em><em><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span></em><em><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"</span></em><span style="font-size:10pt;font-family:'Courier New';"> </span>results in one shot message security. In this mode every message is secured independently -- algorithm suits determines what algorithm should be used to secure the message. By default WCF uses <span style="color:#0070c0;">RSA-OAEP</span>, which uses a symmetric key to encrypt the message and signature. This symmetric key is then wrapped/transported using the public key from the server certificate. All of this security stuff is contained in every SOAP message. </p>
<p class="MsoNormal">With one shot message security there are further two options: </p>
<p class="MsoListParagraph" style="margin-left:1.25in;text-indent:-.25in;"><span style="font-family:'Courier New';">o<span style="font:7pt 'Times New Roman';">   </span></span>Not using derived keys </p>
<p class="MsoNormal">Above explanation was for case in which derived keys were turned off. Some of the other stacks (e.g IBM DataPower) don’t support derived keys yet so in those cases this needs to be turned off. By default wsHttpBinding uses the derived keys and there is no way to turn this off from the config file. You have to use a custom binding, if you need to turn off derived keys. See <a href="http://zamd.net/2008/02/10/changing-messageprotectionorder-for-built-in-bindings/">this</a> for details. By default <em>“derived keys”</em> are turned off in case of basicHttpBinding. </p>
<p class="MsoListParagraph" style="margin-left:1.25in;text-indent:-.25in;"><span style="font-family:'Courier New';">o<span style="font:7pt 'Times New Roman';">   </span></span>Using derived keys </p>
<p class="MsoNormal">With derived keys turned on, WCF derives two keys from the symmetric key and use one to sign the SOAP message and other to encrypt various parts of the SOAP message. It is considered bad practice to sign and encrypt data using the same key as certain attacks are more likely to succeed in this case so derived keys provide more resilient against such attacks and that’s why its enabled on wsHttpBinding as a default option. </p>
<p class="MsoNormal">Setting <em><span style="font-size:10pt;color:red;font-family:'Courier New';">establishSecurityContext</span></em><em><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span></em><em><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">true</span>"</span></em><span style="font-size:10pt;font-family:'Courier New';"> </span>results in a “<em>Security Context Token”</em> established between client and server. Once this token is created on both ends – all subsequent message exchanges will be secured using this context token. By default this token is issued with a 15 minute life time and need to be re-issued if required beyond 15 minutes. Again not using derived keys here means multiple messages (exchanged in 15 minutes life-span) will be secured using the same “<em>Security Context Token”</em> so security in this case will be more weaker than one shot security. So use of derived keys is more important in case of secure conversation. </p>
<p class="MsoListParagraph" style="margin-left:.75in;text-indent:-.25in;"><span style="font-family:Symbol;">·<span style="font:7pt 'Times New Roman';">         </span></span><strong><span style="font-size:10pt;font-family:'Courier New';">negotiateServiceCredential</span></strong> </p>
<p class="MsoNormal">Credential negotiation is a process of exchanging keys and authenticating communicating parties using some form of handshake. Now credential negotiate can be done at the transport level using something like <em>SSL over HTTPS</em> or can be done at <em>SOAP level</em> using <em>TLSNego</em> (<em>SSL over SOAP</em>). </p>
<p class="MsoNormal">Setting <span style="font-size:10pt;color:red;font-family:'Courier New';">negotiateServiceCredential</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>" </span>means that service credentials should be made available to the client using some out-of-band mechanism. Here starts the complexity as WCF supports many different types of credentials and out-of-band availability mechanism is credential specific. </p>
<p class="MsoNormal">So in case of Certificate credentials, service certificate should be provided to all the clients prior to communication and clients should refer the service certificate in their security configuration. </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">clientCredentials</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">serviceCertificate</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">defaultCertificate</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">findValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">localhost</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      </span><span style="font-size:10pt;color:red;font-family:'Courier New';">storeLocation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">LocalMachine</span>"<span style="color:blue;"> </span><span style="color:red;">storeName</span><span style="color:blue;">=</span>"<span style="color:blue;">My</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      </span><span style="font-size:10pt;color:red;font-family:'Courier New';">x509FindType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">FindBySubjectName</span>"<span style="color:blue;">/&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">authentication</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">certificateValidationMode</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">PeerOrChainTrust</span>"<span style="color:blue;"> /&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">serviceCertificate</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">clientCredentials</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal">In case of Kerberos credentials, setting <em><span style="font-size:10pt;color:red;font-family:'Courier New';">negotiateServiceCredential</span></em><em><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span></em><em><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"</span></em><span style="font-size:10pt;font-family:'Courier New';"> </span>results in on-shot Kerberos or sometimes called Kerberos direct. For this mode to work the service must be running under machine SPN (<em>NetworkService</em>, <em>LocalService</em> accounts etc) and client must specify the SPN in the endpoint identity. </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">endpoint</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">address</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://zamd.net/servicemodelsamples/service.svc</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          </span><span style="font-size:10pt;color:red;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">customBinding</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          </span><span style="font-size:10pt;color:red;font-family:'Courier New';">bindingConfiguration</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Binding1</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          </span><span style="font-size:10pt;color:red;font-family:'Courier New';">behaviorConfiguration</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">ClientCredentialsBehavior</span>"</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">          </span><span style="font-size:10pt;color:red;font-family:'Courier New';">contract</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Microsoft.ServiceModel.Samples.ICalculator</span>"<span style="color:blue;"> &gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">identity</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">servicePrincipalName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">value</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">host/zamd.net</span>"<span style="color:blue;">/&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">identity</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">endpoint</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal">Setting <em><span style="font-size:10pt;color:red;font-family:'Courier New';">negotiateServiceCredential</span></em><em><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span></em><em><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">true</span>"</span></em><span style="font-size:10pt;font-family:'Courier New';"> </span>will results in credentials negotiation. Now as mentioned earlier actual negotiation depends on client and service credential type and could either be done at transport level or message level (using appropriate credential exchange protocols) depending on your security mode. Let’s take this example: </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">wsHttpBinding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">name</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Binding1</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">mode</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Message</span>"<span style="color:blue;">&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">      &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">message</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">clientCredentialType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">UserName</span>"<span style="color:blue;"> </span><span style="color:red;">negotiateServiceCredential</span><span style="color:blue;">=</span>"<span style="color:blue;">true</span>"<span style="color:blue;">/&gt;</span></span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">    &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">  &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal" style="margin-left:.5in;"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">wsHttpBinding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span> </p>
<p class="MsoNormal">The above binding will result in <em>UserNameForSslNegotiated</em> credential type -- which uses UserName as client credential type and certificate as service credential and service credentials will be negotiated using <strong><em>SSL over SOAP </em></strong>aka <strong><em>TLSNEGO.</em></strong> </p>
</div>
