---
layout: post
title: Exposing Workflow Service over Azure Service Bus
date: 2011-02-02 12:20:18.000000000 +05:00
type: post
published: true
status: publish
categories: []
tags: []
meta:
  _oembed_d6ad90f060c5ad3214585aff06033f49: '{{unknown}}'
  _oembed_9cd9e31e890f560a204413c398370d5d: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<p>In this post I'll walk you through the steps of exposing a ‘Windows Server AppFabric’ hosted workflow service over the Azure service bus.&#160; IIS/AppFabric hosted services are message activated so they cannot be visible on the servicebus until they are activated. So in this post, I’ll use the AutoStart feature of AppFabric to make my service available over service bus. </p>
<p>Create a workflow service project using Visual Studio </p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;margin:5px;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb.png" width="244" height="170" /></a></p>
<p>VS would generate a .xamlx based service and a default web.config file</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image1.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb1.png" width="244" height="149" /></a></p>
<p>The generated web.config uses the new WCF 4.0 default configuration option so no &lt;service&gt; tag was generated. If you run the service now, default endpoints would automatically be generated based on the base address of the service provided by the IIS. </p>
<p>Service bus endpoints requires an address in the service bus namespace so I can’t use IIS provided base address which means I can’t use the default endpoints feature. So the first set of changes would to be revert back to the old-style explicit endpoint definition.</p>
<pre><font face="Consolas"><span><font color="#0000ff"><font>&#160;&#160;&#160; &lt;</font></font></span><font><span><font color="#a31515">services</font></span></font></font><font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">service</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">name</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">Service1</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">endpoint</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">address</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">http://eval01.servicebus.windows.net/wfappfabric/</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">binding</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">ws2007HttpRelayBinding</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">contract</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">IService</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span>/&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">endpoint</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">address</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">http://eval01.servicebus.windows.net/wfappfabric/mex</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">binding</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">ws2007HttpRelayBinding</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">kind</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">mexEndpoint</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span>/&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">service</font></span></font></font><font face="Consolas"><font><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font face="Consolas"><font><font color="#0000ff"><span></span><span>&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">services</font></span></font><span><font color="#0000ff">&gt;</font></span></font></pre>
<p>The service name &amp; contract name (‘Service1’ &amp; ‘IService’) can be found from the properties of the workflow and the receive activity respectively.&#160; Because I’m using an absolute address for my endpoint, WCF tells me to disable the multipleSiteBindings by removing the following element. </p>
<pre><font face="Consolas"><span><font color="#0000ff"><font>&#160;&#160;&#160; &lt;</font></font></span><font><span><font color="#a31515">serviceHostingEnvironment</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">multipleSiteBindingsEnabled</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">true</font></span><font color="#000000">&quot;</font></font><span><font color="#0000ff"> /&gt;</font></span></font></pre>
<pre>Next I’ll change the default ws2007HttpRelayBinding to disable security.</pre>
<pre><font face="Consolas"><span><font color="#0000ff"><font>&#160;&#160;&#160; &lt;</font></font></span><font><span><font color="#a31515">bindings</font></span></font></font><font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">ws2007HttpRelayBinding</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">binding</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">security</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">mode</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">None</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">relayClientAuthenticationType</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">None</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span> /&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">binding</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">ws2007HttpRelayBinding</font></span></font></font><font face="Consolas"><font><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font face="Consolas"><font><font color="#0000ff"><span></span><span>&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">bindings</font></span></font><span><font color="#0000ff">&gt;</font></span></font></pre>
<p>Configure the ACS security for the ServiceBus and specify the discovery mode to public so that I can see my service in the registry. All of this is done using a default a endpoint behavior.</p>
<pre><font face="Consolas"><span><font color="#0000ff"><font>&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font><span><font color="#a31515">endpointBehaviors</font></span></font></font><font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">behavior</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">serviceRegistrySettings</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">discoveryMode</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">Public</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span> /&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">transportClientEndpointBehavior</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">credentialType</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">SharedSecret</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">clientCredentials</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</span></font><span><font color="#a31515">sharedSecret</font></span><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">issuerName</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">owner</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">&#160;</font></span><span><font color="#ff0000">issuerSecret</font></span><span><font color="#0000ff">=</font></span><font color="#000000">&quot;</font><span><font color="#0000ff">SECRET=</font></span><font color="#000000">&quot;</font></font><font face="Consolas"><font color="#0000ff"><span> /&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">clientCredentials</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">transportClientEndpointBehavior</font></span></font><font face="Consolas"><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font><font face="Consolas"><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">behavior</font></span></font></font><font face="Consolas"><font><font color="#0000ff"><span>&gt;</span></font></font></font></pre>
<pre><font face="Consolas"><font><font color="#0000ff"><span></span><span>&#160;&#160;&#160;&#160;&#160; &lt;/</span></font><span><font color="#a31515">endpointBehaviors</font></span></font><span><font color="#0000ff">&gt;</font></span></font></pre>
<p>Using the project properties, I’ll configure the service to run under IIS/AppFabric</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image2.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;margin:5px;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb2.png" width="244" height="149" /></a></p>
<p>I can now see my endpoints in the AppFabric management console but I can’t see my service in the Service Bus registry because it’s not activated yet. </p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image3.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb3.png" width="244" height="103" /></a></p>
<p>So I need to configure Auto-Start feature on this service which I can easily do using the AppFabric management console.</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image4.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;margin:0;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb4.png" width="244" height="185" /></a></p>
<p>After configuring AutoStart I can straight a way see my service in the registry</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image5.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;margin:0;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb5.png" width="244" height="149" /></a></p>
<p>When I browse to my service I see the standard help page which the metadata URL</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/02/image6.png"><img style="background-image:none;padding-left:0;padding-right:0;display:inline;padding-top:0;border-width:0;margin:5px;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb6.png" width="244" height="149" /></a></p>
<p>Download: <a href="http://cid-724b6fcd63a8c1ac.office.live.com/self.aspx/zamd.net/AppFabricSB/Web.config">Web.config</a></p>
