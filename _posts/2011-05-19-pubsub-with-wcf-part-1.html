---
layout: post
title: Pub/Sub with WCF (Part 1)
date: 2011-05-19 19:47:30.000000000 +05:00
type: post
published: true
status: publish
categories:
- ServiceBusV2
tags: []
meta:
  _oembed_75b34d50523e0968bc963b4e4dcecfe7: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<p><a href="http://cid-724b6fcd63a8c1ac.office.live.com/self.aspx/zamd.net/ServiceBusTopicsWithWCF.zip">Code download</a></p>
<p>In <a href="http://zamd.net/2011/05/18/wcf-with-service-bus-v2-queues/">yesterday’s post</a> I have explored how to use Service Bus queues as a transport to communicate between a WCF client and a service. In today’s post I will show you WCF pub/sub messaging using the topics and subscriptions. A subscription behaves exactly like a queue for reads while a topic behaves exactly like a queue for writes. This metaphor maps nicely to WCF where our services would listen on different subscriptions while the clients would send messages to a single topic. Service Bus would automatically forward matching messages to correct services. </p>
<p>For this example, I have created a simple order service as shown below. The Write extension simply writes to the console using a certain color assigned to a particular host. I have used this to distinguish the service host receiving the messages. </p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:96cd91ee-1481-457a-a754-0e76700fd6b4" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#ffffff;max-height:400px;overflow:auto;white-space:nowrap;padding:2px 5px;"><span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> <span style="color:#2b91af;">Order</span><br /> {<br />     <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">double</span> Amount { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }<br />     <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">string</span> ShipCity { <span style="color:#0000ff;">get</span>; <span style="color:#0000ff;">set</span>; }<br /> }</p>
<p> [<span style="color:#2b91af;">ServiceContract</span>]<br /> <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">interface</span> <span style="color:#2b91af;">IOrderService</span><br /> {<br />     [<span style="color:#2b91af;">OperationContract</span>(IsOneWay = <span style="color:#0000ff;">true</span>)]<br />     <span style="color:#0000ff;">void</span> Submit(<span style="color:#2b91af;">Order</span> order);<br /> }</p>
<p> <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">class</span> <span style="color:#2b91af;">OrderService</span> : <span style="color:#2b91af;">IOrderService</span><br /> {<br />     <span style="color:#0000ff;">public</span> <span style="color:#0000ff;">void</span> Submit(<span style="color:#2b91af;">Order</span> order)<br />     {<br />         <span style="color:#0000ff;">var</span> writer = <span style="color:#2b91af;">OperationContext</span>.Current.Host.Extensions.Find&lt;<span style="color:#2b91af;">Writer</span>&gt;();</p>
<p>         writer.WriteLine(<span style="color:#a31515;">&quot;Received order value = {0}, ShipCity = {1}&quot;</span>, order.Amount, order.ShipCity);<br />     }<br /> }</div>
</p></div>
</p></div>
<p>Next I use the Management API to create topics &amp; related subscriptions.</p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:6c599ccb-83d0-4698-9d30-26c528d528df" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#ffffff;max-height:300px;overflow:auto;padding:2px 5px;"><span style="color:#0000ff;">var</span> baseAddress = <span style="color:#a31515;">&quot;sb://soundbyte.servicebus.appfabriclabs.com&quot;</span>;<br /> <span style="color:#0000ff;">var</span> credential = <span style="color:#2b91af;">TransportClientCredentialBase</span>.CreateSharedSecretCredential(<span style="color:#a31515;">&quot;owner&quot;</span>, <span style="color:#a31515;">&quot;zYDbQ2wM4343dbBukWJTF6Y=&quot;</span>);<br /> <span style="color:#0000ff;">var</span> namespaceClient = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">ServiceBusNamespaceClient</span>(baseAddress, credential);</p>
<p> <span style="color:#0000ff;">try</span><br /> {<br />     namespaceClient.DeleteTopic(<span style="color:#a31515;">&quot;orders&quot;</span>);<br /> }<br /> <span style="color:#0000ff;">catch</span> { }</p>
<p> <span style="color:#0000ff;">var</span> topic= namespaceClient.CreateTopic(<span style="color:#a31515;">&quot;orders&quot;</span>);<br /> topic.AddSubscription(<span style="color:#a31515;">&quot;london&quot;</span>, <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">SqlFilterExpression</span>(<span style="color:#a31515;">&quot;ShipCity = &#039;london&#039;&quot;</span>));<br /> topic.AddSubscription(<span style="color:#a31515;">&quot;reading&quot;</span>, <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">SqlFilterExpression</span>(<span style="color:#a31515;">&quot;ShipCity = &#039;reading&#039;&quot;</span>));</div>
</p></div>
</p></div>
<p>Both subscriptions has a filter applied to them and only the messages matching this filter would be delivered to the subscription. I then create two separate service hosts simulating separate services running in different cities. I assigned ‘Cyan’ color to the London host (simulated service hosted in London) and ‘Yellow’ to the Reading Host (Service hosted in Reading).</p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:0ba24c27-03bf-42dd-a298-3bc73c0a2874" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#ffffff;max-height:300px;overflow:auto;padding:2px 5px;"><span style="color:#0000ff;">var</span> serviceBusBinding = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">ServiceBusMessagingBinding</span>();<br /> serviceBusBinding.MessagingFactorySettings.Credential = credential;</p>
<p> <span style="color:#0000ff;">string</span> topicAddress = baseAddress + <span style="color:#a31515;">&quot;/orders&quot;</span>;<br /> <span style="color:#0000ff;">string</span> londonSubscription = baseAddress + <span style="color:#a31515;">&quot;/orders/subscriptions/london&quot;</span>;<br /> <span style="color:#0000ff;">string</span> readingSubscription = baseAddress + <span style="color:#a31515;">&quot;/orders/subscriptions/reading&quot;</span>;</p>
<p> <span style="color:#0000ff;">var</span> hostLondon = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">ServiceHost</span>(<span style="color:#0000ff;">typeof</span>(<span style="color:#2b91af;">OrderService</span>));<br /> hostLondon.Extensions.Add(<span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Writer</span>(<span style="color:#2b91af;">ConsoleColor</span>.Cyan));<br /> hostLondon.AddServiceEndpoint(<span style="color:#0000ff;">typeof</span>(<span style="color:#2b91af;">IOrderService</span>), serviceBusBinding, <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Uri</span>(topicAddress), <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Uri</span>(londonSubscription));<br /> hostLondon.Open();</p>
<p> <span style="color:#0000ff;">var</span> hostReading = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">ServiceHost</span>(<span style="color:#0000ff;">typeof</span>(<span style="color:#2b91af;">OrderService</span>));<br /> hostReading.Extensions.Add(<span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Writer</span>(<span style="color:#2b91af;">ConsoleColor</span>.Yellow));<br /> hostReading.AddServiceEndpoint(<span style="color:#0000ff;">typeof</span>(<span style="color:#2b91af;">IOrderService</span>), serviceBusBinding, <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Uri</span>(topicAddress), <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Uri</span>(readingSubscription));<br /> hostReading.Open();</div>
</p></div>
</p></div>
<p>Next I have created a simple WCF client using the ChannelFactory API and used it to send messages to the topic. In the current CTP, you have to set the filter properties separately on the BrokeredMessage object, which is a native ServiceBus message object and is different from the WCF Message object. </p>
<p>ServiceBusMessagingBinding automatically converts the WCF message object (generated by the proxy object) to a BrokeredMessage object which is then sent to ServiceBus. On the receive side a similar conversion happens from BrokeredMessage to a WCF Message which is then on to WCF Service. To set BrokeredMessage specific properties, we need to create a BrokeredMessageProperty object, set the properties on it and add it to generated WCF messages. ServiceBusMessagingBinding looks for this property and copy all the properties to the BrokeredMessage object it creates. I’m doing exactly the same using the OperationContextScope below.</p>
<p>
<div style="display:inline;float:none;margin:0;padding:0;" id="scid:9ce6104f-a9aa-4a17-a79f-3a39532ebf7c:de725806-9913-4801-9063-27572619df11" class="wlWriterEditableSmartContent">
<div style="border:#000080 1px solid;color:#000;font-family:'Courier New', Courier, Monospace;font-size:10pt;">
<div style="background-color:#ffffff;max-height:300px;overflow:auto;padding:2px 5px;"><span style="color:#0000ff;">var</span> cf = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">ChannelFactory</span>&lt;<span style="color:#2b91af;">IOrderService</span>&gt;(serviceBusBinding, topicAddress);<br /> <span style="color:#0000ff;">var</span> proxy = cf.CreateChannel();</p>
<p> <span style="color:#0000ff;">using</span> (<span style="color:#0000ff;">new</span> <span style="color:#2b91af;">OperationContextScope</span>( (<span style="color:#2b91af;">IContextChannel</span>)  proxy))<br /> {<br />     <span style="color:#0000ff;">var</span> bmp = <span style="color:#0000ff;">new</span> <span style="color:#2b91af;">BrokeredMessageProperty</span>();<br />     bmp.Properties[<span style="color:#a31515;">&quot;ShipCity&quot;</span>] = <span style="color:#a31515;">&quot;london&quot;</span>;<br />     <span style="color:#2b91af;">OperationContext</span>.Current.OutgoingMessageProperties.Add(<span style="color:#2b91af;">BrokeredMessageProperty</span>.Name, bmp);<br />     proxy.Submit(<span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Order</span> {Amount = 200, ShipCity = <span style="color:#a31515;">&quot;london&quot;}</span>);</p>
<p>     bmp.Properties[<span style="color:#a31515;">&quot;ShipCity&quot;</span>] = <span style="color:#a31515;">&quot;reading&quot;</span>;<br />     proxy.Submit(<span style="color:#0000ff;">new</span> <span style="color:#2b91af;">Order</span> { Amount = 322, ShipCity = <span style="color:#a31515;">&quot;london&quot;</span> });</p>
<p> }</p></div>
</p></div>
</p></div></p>
<p>As you can see from the following output that the ‘london’ message was received by London host (‘yellow’) while the ‘reading’ message was received by Reading (‘cyan’) service host.</p>
<p><a href="http://zuahmed.files.wordpress.com/2011/05/image1.png"><img style="background-image:none;border-bottom:0;border-left:0;padding-left:0;padding-right:0;display:inline;border-top:0;border-right:0;padding-top:0;" title="image" border="0" alt="image" src="{{ site.baseurl }}/assets/image_thumb1.png" width="644" height="244" /></a></p>
<p>Finally yes it looks bit ugly that I have to specify these promoted/filter properties separately <img style="border-style:none;" class="wlEmoticon wlEmoticon-sadsmile" alt="Sad smile" src="{{ site.baseurl }}/assets/wlemoticon-sadsmile.png" />from their WCF contract values. Ideally ServiceBus APIs should have picked up the ShipCity property from my Order object.&#160; Unfortunately in the current CTP you have to do this separately as I have shown you in the above snippet.&#160; In the next post I’ll show how you can extend WCF so that it automatically picks these ‘filter properties’&#160; from operations parameters or WCF DataContract(s). </p>
<p>Stay tuned…</p>
