---
layout: post
title: Durable Duplex Messaging in .Net 4 Beta2
date: 2009-10-28 12:10:25.000000000 +06:00
type: post
published: true
status: publish
categories:
- WF4
tags: []
meta:
  _edit_last: '13661190'
  _oembed_91d5aa0fd02a02b6a50ae5ef6237c2ca: '{{unknown}}'
  _oembed_0ae4cf07c4886db36c32f9a6f0e3ab69: '{{unknown}}'
  _oembed_be72bdf4e5cf6455af6ad9184621d0c1: '{{unknown}}'
  _oembed_321c4f186b1348497f54c6742c7a799a: '{{unknown}}'
  _oembed_41d6d47051060f93451b45cc073f8886: '{{unknown}}'
  _oembed_e39d2b1a4b579330ae2df587ea8dd4aa: '{{unknown}}'
  _oembed_ce0b0cfaaf85da696e6cf9f712db7f73: '{{unknown}}'
  _oembed_ab4dd791ec2f9a15b7f2f4af80f1f884: '{{unknown}}'
  _oembed_b7febbbad4200b03dba53e8824d2ef60: '{{unknown}}'
  _oembed_e20ae334fcde3527c0122b5a1fb0b1fc: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal"><a href="http://zamd.net/2009/06/05/duplex-communication-with-net-3-5-workflow-services/">Here</a> I talked about couple of approaches to enable durable duplex messaging in .Net 3.5.</p>
<p class="MsoNormal">.NET 4 has added first class support for durable duplex messaging by extending <a href="http://msdn.microsoft.com/en-us/library/bb924468.aspx">Context Exchange Protocol</a> to include a CallbackContext. So in addition to instanceId, a client application can send a callback context as part of the call.</p>
<p class="MsoNormal">Service, upon receiving the message, will start the long running work and when it needs to callback to client, it can simply use the address from the callback context.</p>
<p class="MsoNormal">From API perspective – a new property “ClientCallbackAddress” is added to ContextBindingElement. This property is also exposed on some higher level bindings like wsHttpContextBinding.</p>
<p class="MsoNormal">A new CallbackContextMessageProperty is also added to manipulate callback context from the application code.</p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">  &lt;</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">bindings</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">&gt;</span><span style="font-size:9.5pt;font-family:Consolas;"> </span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">    &lt;</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">wsHttpContextBinding</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">      &lt;</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">binding</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;"> </span><span style="font-size:9.5pt;font-family:Consolas;color:red;">name</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">=</span><span style="font-size:9.5pt;font-family:Consolas;">"<span style="color:blue;">noSec</span>"<span style="color:blue;"> </span><span style="color:red;background:aqua;">clientCallbackAddress</span><span style="color:blue;background:aqua;">=</span><span style="background:aqua;">"<span style="color:blue;">http://localhost:7080</span>"<span style="color:blue;">&gt;</span></span></span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">        &lt;</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">security</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;"> </span><span style="font-size:9.5pt;font-family:Consolas;color:red;">mode</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">=</span><span style="font-size:9.5pt;font-family:Consolas;">"<span style="color:blue;">None</span>"<span style="color:blue;">/&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">      &lt;/</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">binding</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">    &lt;/</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">wsHttpContextBinding</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">  &lt;/</span><span style="font-size:9.5pt;font-family:Consolas;color:#a31515;">bindings</span><span style="font-size:9.5pt;font-family:Consolas;color:blue;">&gt;</span></p>
<p class="MsoNormal">Any messages sent using above binding will have a callback context attached to it. Please note callback context is only supported with SOAP based context exchange and that’s why <span style="font-size:9.5pt;font-family:Consolas;color:red;">clientCallbackAddress</span> property is NOT exposed on basicHttpContextBinding as it uses HTTP cookies for context exchange.</p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">var</span><span style="font-size:9.5pt;font-family:Consolas;"> cf = <span style="color:blue;">new</span> <span style="color:#2b91af;">ChannelFactory</span>&lt;<span style="color:#2b91af;">IRequestChannel</span>&gt;(<span style="color:blue;">new</span> <span style="color:#2b91af;">WSHttpContextBinding</span>(<span style="color:#a31515;">"noSec"</span>), </span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">                                             new</span><span style="font-size:9.5pt;font-family:Consolas;"> <span style="color:#2b91af;">EndpointAddress</span>(<span style="color:#a31515;">"http://localhost:8975/"</span>));</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">var</span><span style="font-size:9.5pt;font-family:Consolas;"> ccmp = <span style="color:blue;">new</span> <span style="color:#2b91af;">CallbackContextMessageProperty</span>(<span style="color:blue;">new</span> <span style="color:#2b91af;">Dictionary</span>&lt;<span style="color:blue;">string</span>,<span style="color:blue;">string</span>&gt;());</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;"> </span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;color:blue;">var</span><span style="font-size:9.5pt;font-family:Consolas;"> msg = <span style="color:#2b91af;">Message</span>.CreateMessage(<span style="color:#2b91af;">MessageVersion</span>.Default, <span style="color:#a31515;">"urn:foo"</span>, <span style="color:#a31515;">""</span>);</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;">msg.Properties.Add(<span style="color:#2b91af;">CallbackContextMessageProperty</span>.Name, ccmp);</span></p>
<p class="MsoNormal"><span style="font-size:9.5pt;font-family:Consolas;">cf.CreateChannel().Request(msg);</span></p>
<p class="MsoNormal">This will produce following SOAP envelop and you can see CallbackContext header is added in outgoing message.</p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">&lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Envelope</span><span style="font-size:10pt;font-family:&quot;color:blue;"> </span><span style="font-size:10pt;font-family:&quot;color:red;">xmlns:s</span><span style="font-size:10pt;font-family:&quot;color:blue;">=</span><span style="font-size:10pt;font-family:&quot;">"<span style="color:blue;">http://www.w3.org/2003/05/soap-envelope</span>"<span style="color:blue;"> </span><span style="color:red;">xmlns:a</span><span style="color:blue;">=</span>"<span style="color:blue;">http://www.w3.org/2005/08/addressing</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">  &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Header</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:Action</span><span style="font-size:10pt;font-family:&quot;color:blue;"> </span><span style="font-size:10pt;font-family:&quot;color:red;">s:mustUnderstand</span><span style="font-size:10pt;font-family:&quot;color:blue;">=</span><span style="font-size:10pt;font-family:&quot;">"<span style="color:blue;">1</span>"<span style="color:blue;">&gt;</span>urn:foo<span style="color:blue;">&lt;/</span><span style="color:#a31515;">a:Action</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:MessageID</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span><span style="font-size:10pt;font-family:&quot;">urn:uuid:c7c03178-fa84-400e-8673-ad1ed28f0f79<span style="color:blue;">&lt;/</span><span style="color:#a31515;">a:MessageID</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:ReplyTo</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">      &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:Address</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span><span style="font-size:10pt;font-family:&quot;">http://www.w3.org/2005/08/addressing/anonymous<span style="color:blue;">&lt;/</span><span style="color:#a31515;">a:Address</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:ReplyTo</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    <span style="background:aqua;">&lt;</span></span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">CallbackContext</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;"> </span><span style="font-size:10pt;font-family:&quot;color:red;background:aqua;">xmlns</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">=</span><span style="font-size:10pt;font-family:&quot;background:aqua;">"<span style="color:blue;">http://schemas.microsoft.com/ws/2008/02/context</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">      &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">CallbackEndpointReference</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">        &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">a:Address</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span><span style="font-size:10pt;font-family:&quot;background:aqua;">http://localhost:7080/<span style="color:blue;">&lt;/</span><span style="color:#a31515;">a:Address</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">        &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">a:ReferenceParameters</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">          &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">Context</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;"> </span><span style="font-size:10pt;font-family:&quot;color:red;background:aqua;">xmlns</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">=</span><span style="font-size:10pt;font-family:&quot;background:aqua;">"<span style="color:blue;">http://schemas.microsoft.com/ws/2006/05/context</span>"<span style="color:blue;">/&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">        &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">a:ReferenceParameters</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">      &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">CallbackEndpointReference</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">    &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;background:aqua;">CallbackContext</span><span style="font-size:10pt;font-family:&quot;color:blue;background:aqua;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">a:To</span><span style="font-size:10pt;font-family:&quot;color:blue;"> </span><span style="font-size:10pt;font-family:&quot;color:red;">s:mustUnderstand</span><span style="font-size:10pt;font-family:&quot;color:blue;">=</span><span style="font-size:10pt;font-family:&quot;">"<span style="color:blue;">1</span>"<span style="color:blue;">&gt;</span>http://localhost:8975/<span style="color:blue;">&lt;/</span><span style="color:#a31515;">a:To</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">  &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Header</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">  &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Body</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">    &lt;</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">string</span><span style="font-size:10pt;font-family:&quot;color:blue;"> </span><span style="font-size:10pt;font-family:&quot;color:red;">xmlns</span><span style="font-size:10pt;font-family:&quot;color:blue;">=</span><span style="font-size:10pt;font-family:&quot;">"<span style="color:blue;">http://schemas.microsoft.com/2003/10/Serialization/</span>"<span style="color:blue;">/&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">  &lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Body</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:blue;">&lt;/</span><span style="font-size:10pt;font-family:&quot;color:#a31515;">s:Envelope</span><span style="font-size:10pt;font-family:&quot;color:blue;">&gt;</span></p>
<p class="MsoNormal">On the server side, you can pick up the CallBackContext from the Message Properties and use it for call-backs. So far I have shown kind of a manual way of dealing with callback context. Workflow services in .Net 4 along with correlation feature has really simplified all this and you never need to muck with <span style="font-size:9.5pt;font-family:Consolas;color:#2b91af;">CallbackContextMessageProperty </span>etc.</p>
<p class="MsoNormal">In your client workflow, simply make sure you have an active correlation handle on your send activity and then use a binding capable of transporting callback context (e.g. wsHttpContextBinding mentioned earlier)</p>
<p class="MsoNormal"> </p>
<p class="MsoNormal">In your server side workflow, simply make sure that Receive and Send (used for callback) activities are correlated either using implicitly or explicit correlation and that’s it.</p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:&quot;color:#595959;"><img src="{{ site.baseurl }}/assets/image005.jpg" border="0" alt="" width="271" height="302" /></span></p>
<p class="MsoNormal">You don’t need to specify Endpoint Address on your Send activity and it will automatically pick it from CallbackContext.</p>
</div>
