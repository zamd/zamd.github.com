---
layout: post
title: 'Part2: ACS Federation with Custom STS'
date: 2009-01-23 18:29:32.000000000 +05:00
type: post
published: true
status: publish
categories:
- .NET Services
tags: []
meta:
  _edit_last: '13661190'
  _oembed_d7be6a3b1e6d7dfe16b05a974ea7e126: '{{unknown}}'
  _oembed_8eb0f711788bceb1799256f9fbbe26ce: '{{unknown}}'
  _oembed_abea82f75449e124aa8f80eca80dddf5: '{{unknown}}'
  _oembed_2dc9562f693b8f6fb1489f9cd71ad57f: '{{unknown}}'
  _oembed_49f037572bede8ab79746a3df13d478a: '{{unknown}}'
  _oembed_2c58d793c9dca5999e3fff1819036f58: '{{unknown}}'
  _oembed_1769f2c23d6d3120874b9a72e8db2e0c: '{{unknown}}'
  _oembed_5f11243cdedb7b7faa5a497f8388cce8: '{{unknown}}'
  _oembed_ecf431b6b91c2bd9bac543f7ab405d63: '{{unknown}}'
  _oembed_bebf3d740bb3c6a07e98ba30215462e2: '{{unknown}}'
author:
  login: zamd
  email: zulfiqar.ahmed@gmail.com
  display_name: zamd
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">In </font><a href="http://zamd.net/2009/01/22/AccessControlServicePart1.aspx"><font color="#0000ff">yesterday’s post</font></a><font color="#000000"> I talked about ACS and how to interact with it as a standard web service, providing claims transformation functionality. Today I will show how we can federate ACS with our custom STS written using Geneva Framework. This architecture opens up many interesting scenarios. Here are the major steps involved in this architecture.</font></span></p>
<ul>
<li>
<div class="MsoNormal"><span style="color:#1f497d;"></span><span style="color:#1f497d;"><font color="#000000">We need to establish a trust relationship between our local STS and Access Control Service (ACS). We can do this using ACS web portal. This is essentially just exchange of certificate(s)</font></span></div>
</li>
<li>
<div class="MsoNormal"><span style="color:#1f497d;"></span><font color="#000000"><span style="color:#1f497d;font-family:Symbol;"><span><span style="font:7pt 'Times New Roman';"><font color="#000000">&nbsp;</font></span></span></span><span style="color:#1f497d;"><font color="#000000">I have already created a </font><a href="http://zamd.net/2008/07/10/CreatingABasicSTSUsingGenevaFrameworkAkaZermatt.aspx"><font color="#0000ff">simple STS</font></a><font color="#000000">, which runs on the same machine as my client, so it will issue tokens to any caller (anonymous or</font> <font color="#000000">authenticated).</font></span></font></div>
</li>
<li>
<div class="MsoNormal"><span style="color:#1f497d;"></span><span style="color:#1f497d;"><font color="#000000">Once I got token from my local STS, I will pass this token to ACS, which will use the claims contained in this token to derive its transformation logic and will return a new token with different claims.</font></span></div>
</li>
<li>
<div class="MsoNormal"><span style="color:#1f497d;"></span><span style="color:#1f497d;"><font color="#000000">I can now present this new token to any web service or web site (which trust ACS) and get my job done.</font></span></div>
</li>
</ul>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">Here is simple code, which first gets token from local STS and then uses it to get a new token from ACS.</font></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">private</span><span style="font-size:10pt;font-family:'Courier New';"> <span style="color:blue;">static</span> <span style="color:blue;">void</span> GetTokenFromACS Using SAMLToken GeneratedBy MyCustomSTS()</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">{</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:green;">// This is using WSFed binding - so WCF is doing it's magic of intermediate token acquistion.</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> binding = <span style="color:blue;">new</span> <span style="color:#2b91af;">CustomBinding</span>(<span style="color:#a31515;">"IssuedTokenForCertificate"</span>);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; </span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> acsCert = GetACSCertificate();</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> identity = <span style="color:blue;">new</span> <span style="color:#2b91af;">X509CertificateEndpointIdentity</span>(acsCert);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> epa = <span style="color:blue;">new</span> <span style="color:#2b91af;">EndpointAddress</span>(<span style="color:blue;">new</span> <span style="color:#2b91af;">Uri</span>(<span style="color:#a31515;">"<span style="background:yellow;">http://accesscontrol.windows.net/sts/eval01/saml for certificate</span>"</span>), identity);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> trustVersion = <span style="color:#2b91af;">TrustVersion</span>.WSTrust13;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> clientCredentials = <span style="color:blue;">new</span> <span style="color:#2b91af;">ClientCredentials</span>();</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:#2b91af;">WSTrustClient</span> client = <span style="color:blue;">new</span> <span style="color:#2b91af;">WSTrustClient</span>(binding, epa, trustVersion, clientCredentials);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:#2b91af;">RequestSecurityToken</span> rst = <span style="color:blue;">new</span> <span style="color:#2b91af;">RequestSecurityToken</span>(<span style="color:#2b91af;">RequestTypeConstants</span>.Issue, <span style="color:#2b91af;">KeyTypeConstants</span>.Symmetric);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; <span style="color:blue;">try</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#2b91af;">RequestSecurityTokenResponse</span> rstr;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> token = client.Issue(rst, <span style="color:blue;">out</span> rstr) <span style="color:blue;">as</span> <span style="color:#2b91af;">GenericXmlSecurityToken</span>;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> rpCert = <span style="color:blue;">new</span> <span style="color:#2b91af;">X509Certificate2</span>(<span style="color:#a31515;">"zamdnetprivatekeycert.pfx"</span>, <span style="color:#a31515;">"a"</span>);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue;">var</span> txtStat = ExtractSAMLAssertion(token, rpCert);</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp; &nbsp;&nbsp;<span style="color:blue;">catch</span> (<span style="color:#2b91af;">Exception</span> exp)</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#2b91af;">Console</span>.WriteLine(exp.ToString());</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';">}</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:'Courier New';"><font face="Verdana">One important difference from yesterday's post is:&nbsp;we are not using&nbsp;ACS solution credentials here at all (solution userId, password etc). Why? Because we are authenticating with&nbsp;our local STS, and ACS&nbsp;simply trust the token issued by our local STS. With the architecture, we can easily go and change our authentication mechansim with our local STS (go from Annonymous to kerberos) without effecting ACS.</font></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">This is how the binding configuration look like:</font></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">name</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">IssuedTokenForCertificate</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">authenticationMode</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">IssuedTokenForCertificate</span>"</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;color:red;font-family:'Courier New';">messageSecurityVersion</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">WSSecurity11WSTrust13WSSecureConversation13WSSecurityPolicy12BasicSecurityProfile10</span>"</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;color:red;font-family:'Courier New';">requireSignatureConfirmation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">issuedTokenParameters</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">keyType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">SymmetricKey</span>"<span style="color:blue;"> </span><span style="color:red;">tokenType</span><span style="color:blue;">=</span>"<span style="color:blue;">http://docs.oasis-open.org/wss/oasis-wss-saml-token-profile-1.1#SAMLV1.1</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">claimTypeRequirements</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">add</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">claimType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name</span>"<span style="color:blue;"> /&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">claimTypeRequirements</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">issuer</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">address</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://localhost:9000/STS</span>"<span style="color:blue;"> </span><span style="color:red;">binding</span><span style="color:blue;">=</span>"<span style="background:yellow;color:blue;">wsHttpBinding</span>"</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;color:red;font-family:'Courier New';">bindingConfiguration</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">AnnonyForCertificate</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">identity</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">certificate</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">encodedValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;"> +7y1Gj9Ta2w==</span>"<span style="color:blue;"> /&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">identity</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">issuer</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">issuerMetadata</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">address</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://localhost:9000/STS/mex</span>"<span style="color:blue;"> /&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">issuedTokenParameters</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">secureConversationBootstrap</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> /&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">httpTransport</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> /&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">So you can see from the above that we are talking to our local STS using wsHttpBinding configured to allow anonymous access. </font></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">name</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">AnnonyForCertificate</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">mode</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">Message</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">message</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">clientCredentialType</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="background:yellow;color:blue;">None</span>"<span style="color:blue;"> </span><span style="color:red;">negotiateServiceCredential</span><span style="color:blue;">=</span>"<span style="color:blue;">false</span>"</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;color:red;font-family:'Courier New';">establishSecurityContext</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">false</span>"<span style="color:blue;"> /&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">security</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">binding</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">By decrypting the token I can see following assertions returned by ACS.</font></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeStatement</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:saml</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">urn:oasis:names:tc:SAML:1.0:assertion</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Subject</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:SubjectConfirmation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:ConfirmationMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">urn:oasis:names:tc:SAML:1.0:cm:holder-of-key<span style="color:blue;">&lt;/</span><span style="color:#a31515;">saml:ConfirmationMethod</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2000/09/xmldsig#</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptedKey</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:e</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2001/04/xmlenc#</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptionMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">Algorithm</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">DigestMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">Algorithm</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://www.w3.org/2000/09/xmldsig#sha1</span>"<span style="color:blue;"> /&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptionMethod</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">o:SecurityTokenReference</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">xmlns:o</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509Data</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerSerial</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerName</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">CN=Root Agency<span style="color:blue;">&lt;/</span><span style="color:#a31515;">X509IssuerName</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509SerialNumber</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">53391460269745460375752793295988585963<span style="color:blue;">&lt;/</span><span style="color:#a31515;">X509SerialNumber</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509IssuerSerial</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">X509Data</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">o:SecurityTokenReference</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherData</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;font-family:'Courier New';">mhZrKiIRoUyuwy8yXCMWq/xe3H8YyZOh4wMSMh3FknjIamC7QLBhiQAfV1DvQXNJhlY=<span style="color:blue;">&lt;/</span><span style="color:#a31515;">e:CipherValue</span><span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:CipherData</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">e:EncryptedKey</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">KeyInfo</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:SubjectConfirmation</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Subject</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;background:yellow;color:red;font-family:'Courier New';">AttributeName</span><span style="font-size:10pt;background:yellow;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;background:yellow;font-family:'Courier New';">"<span style="color:blue;">action</span>"</span><span style="font-size:10pt;color:blue;font-family:'Courier New';"> </span><span style="font-size:10pt;color:red;font-family:'Courier New';">AttributeNamespace</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">=</span><span style="font-size:10pt;font-family:'Courier New';">"<span style="color:blue;">http://docs.oasis-open.org/wsfed/authorization/200706/claims</span>"<span style="color:blue;">&gt;</span></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp;&nbsp;&nbsp; &lt;</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="font-size:10pt;background:yellow;font-family:'Courier New';">that's done</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeValue</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&nbsp; &lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:Attribute</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:'Courier New';">&lt;/</span><span style="font-size:10pt;color:#a31515;font-family:'Courier New';">saml:AttributeStatement</span><span style="font-size:10pt;color:blue;font-family:'Courier New';">&gt;</span><span style="color:#1f497d;"></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">Now let me show you how I have established the trust relationship between my STS &amp; ACS and how I configured ACS to return single claim in returned SAML token. </font></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><img height="387" src="{{ site.baseurl }}/assets/image003.png" width="705" border="0" /></span></p>
<p class="MsoNormal"><span style="color:#1f497d;">&nbsp;</span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">So the above rule says: If you get a token issued by <b>zamd.net</b> (which is my local STS) and it contains a <b>Name</b> claim with the value of <b>Zulfiqar. </b>Please send back an <b>Action</b> claim with the value of “<b>that’s done</b>”. &nbsp;Because that’s the only rule dealing with my local STS that’s why the returned token has only one claim in it.</font></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">And finally this is how I established a trust relationship between my STS and ACS. I added a new issuer using the Portal, uploading my STSs public key certifcate to ACS and that’s it. </font></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><img height="348" src="{{ site.baseurl }}/assets/image005.png" width="674" border="0" /></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">Now with this certificate, ACS can correctly validate that incomming token is indeed issued by my local STS(because STS signs the issued token), and then runs the transformation logic to choose correct set of claims to return back.</font></span></p>
<p class="MsoNormal"><span style="color:#1f497d;"><font color="#000000">In this post, all the funcationality of going to the local STS, getting token and attaching it to the <b>Issue</b> call made to ACS is done by <b>WSFederationHttpBinding</b>. In the next post,I will show a more explicit way of achieving the same result, so that you can &nbsp;have control over the token issued by your local STS, you can cache etc, and then forward it to ACS on your will.&nbsp; Stay tuned...</font></span></p>
</div>
